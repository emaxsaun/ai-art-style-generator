(()=>{var z=!1,de=new Audio("shutter.wav"),I=[],r=document.getElementById("style-select"),d=document.getElementById("custom-prompt");async function ee(){let e=await(await fetch("/api/styles")).json();I=e;let l=k.value,s=r.value;if(r.innerHTML="",l==="fofr"){b.forEach(n=>{let o=document.createElement("option");o.value=n,o.textContent=n,r.appendChild(o)});let i=b.includes(s)?s:b[Math.floor(Math.random()*b.length)];r.value=i,d.value=`A portrait image in the style of ${r.value}`,d.disabled=!0,d.style.opacity="0.6"}else{e.forEach(y=>{let E=document.createElement("option");E.value=y.name,E.textContent=y.name,r.appendChild(E)});let i=e.find(y=>y.name===s),n=e[Math.floor(Math.random()*e.length)],o=i?i.name:n.name;r.value=o;let v=`A portrait ${l==="photomaker"?"img":"image"} in the style of ${r.value}`;d.value=v,d.disabled=!1,d.style.opacity="1"}}ee();var b=["3D","Emoji","Video game","Pixels","Clay","Toy"],k=document.getElementById("model-select");k.addEventListener("change",()=>{let t=k.value,e=r.value;if(t==="fofr"){r.innerHTML="";let l=k.value;if(r.innerHTML="",l==="fofr"){b.forEach(n=>{let o=document.createElement("option");o.value=n,o.textContent=n,r.appendChild(o)});let i=b[Math.floor(Math.random()*b.length)];r.value=i,d.value=`A portrait img in the style of ${i}`,d.disabled=!0,d.style.opacity="0.6"}else{styles.forEach(n=>{let o=document.createElement("option");o.value=n.name,o.textContent=n.name,r.appendChild(o)});let i=styles[Math.floor(Math.random()*styles.length)];r.value=i.name,d.value=i.prompt,d.disabled=!1,d.style.opacity="1"}let s=b[Math.floor(Math.random()*b.length)];r.value=s,d.value=`A portrait image in the style of ${s}`,d.disabled=!0,d.style.opacity="0.6"}else{r.innerHTML="",I.forEach(n=>{let o=document.createElement("option");o.value=n.name,o.textContent=n.name,r.appendChild(o)});let l=I[0].name,s=I.find(n=>n.name===e);r.value=s?e:l;let i=t==="photomaker"?"img":"image";d.value=`A portrait ${i} in the style of ${r.value}`,d.disabled=!1,d.style.opacity="1"}});var ce=document.getElementById("generate-collage");ce.addEventListener("click",async()=>{let t=document.getElementById("download-btn");t.style.display="none";let e=document.getElementById("share-buttons");if(e.style.display="none",!c.files||c.files.length===0){g.textContent="Please upload a file before generating a collage.",g.style.display="block";return}g.style.display="none",U.textContent="",w.style.display="none",D.style.display="inline-block";let l=document.getElementById("progress-bar"),s=document.getElementById("progress-text");l.style.display="block",s.style.display="block",l.value=0,s.textContent="0%";let i=1e4,n=Date.now(),o=setInterval(()=>{let v=Date.now()-n,y=Math.min(100,Math.floor(v/i*100));l.value=y,s.textContent=`${y}%`,y>=100&&clearInterval(o)},200),h=new FormData;h.append("photo",c.files[0]);try{let y=await(await fetch("/api/collage",{method:"POST",body:h})).json();D.style.display="none",clearInterval(o),l.style.display="none",s.style.display="none",y.success?(w.src=y.imageUrl,w.style.display="block",U.textContent="Collage generated!",t.style.display="inline-block"):(g.textContent=y.error||"An error occurred during collage generation.",g.style.display="block")}catch(v){D.style.display="none",clearInterval(o),l.style.display="none",s.style.display="none",g.textContent="An error occurred. Please try again.",g.style.display="block",console.error(v)}});r.addEventListener("change",()=>{let t=k.value,e=t==="photomaker"?"img":"image";t==="fofr"?d.value=`A portrait image in the style of ${r.value}`:d.value=`A portrait ${e} in the style of ${r.value}`});var te=document.getElementById("upload-form"),w=document.getElementById("result-img"),U=document.getElementById("style-display"),g=document.getElementById("error-message"),D=document.getElementById("loading-spinner"),c=document.getElementById("photo"),B=document.getElementById("filename-display");c.addEventListener("change",()=>{let t=document.getElementById("image-url");t&&(t.value=""),setTimeout(()=>{c.files&&c.files.length>0?B.textContent=c.files[0].name:B.textContent="No file chosen"},0)});var q=document.getElementById("image-url");q.addEventListener("input",()=>{if(q.value.trim()){let t=q.value.trim().split("/").pop().split("?")[0];B.textContent=t||"URL image selected"}else B.textContent="No file chosen"});var M=document.getElementById("drop-area");function ne(){window.innerWidth<768?M.style.display="none":M.style.display="block"}ne();window.addEventListener("resize",()=>{a.classList.contains("hidden")||H()});window.addEventListener("resize",ne);["dragenter","dragover"].forEach(t=>{M.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),M.classList.add("dragover")})});["dragleave","drop"].forEach(t=>{M.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),M.classList.remove("dragover")})});M.addEventListener("drop",t=>{let e=t.dataTransfer.files;e.length>0&&e[0].type.startsWith("image/")&&(c.files=e,B.textContent=e[0].name)});var X=document.getElementById("open-camera"),C=document.getElementById("toggle-camera"),S=document.getElementById("camera-modal"),f=document.getElementById("camera-stream"),W=document.getElementById("take-photo"),u=document.getElementById("snapshot"),oe=document.getElementById("close-camera"),F,j=!0,le,R,T=u.getContext("2d");async function G(){let t=j?"user":"environment";try{F=await navigator.mediaDevices.getUserMedia({video:{facingMode:t}}),f.srcObject=F,j?f.classList.add("mirror-preview"):f.classList.remove("mirror-preview")}catch(e){console.log("Could not access camera: "+e.message),S.classList.add("hidden")}}function $(){let t=window.innerWidth<768;!S.classList.contains("hidden")&&!z?C.style.display=t?"inline-block":"none":C.style.display="none"}$();window.addEventListener("resize",$);function J(){F&&(F.getTracks().forEach(t=>t.stop()),F=null)}X.addEventListener("click",async()=>{z=!1,S.classList.remove("hidden"),u.classList.add("hidden"),f.style.display="block",W.style.display="inline-block",window.innerWidth<768?C.style.display="inline-block":C.style.display="none",a.style.display="none",m&&m.remove(),await G(),H(),$()});C.addEventListener("click",async()=>{j=!j,J(),await G(),H()});oe.addEventListener("click",()=>{J(),S.classList.add("hidden"),ae(),u.classList.add("hidden"),f.style.display="block",W.style.display="inline-block",a.style.display="none",m&&m.remove(),c.value="",B.textContent="No file chosen",$(),z=!1,X.disabled=!1});var a=document.createElement("div");a.style.position="absolute";a.style.top=0;a.style.left=0;a.style.right=0;a.style.bottom="74px";a.style.display="flex";a.style.alignItems="center";a.style.justifyContent="center";a.style.fontSize="6rem";a.style.color="white";a.style.textShadow="0 0 10px black";a.style.backgroundColor="rgba(0,0,0,0.5)";a.style.zIndex=10;a.style.borderRadius="12px";a.style.userSelect="none";a.style.pointerEvents="none";a.style.display="none";S.style.position="relative";S.appendChild(a);function ae(){clearInterval(le),a.style.display="none"}var m;function me(){m=document.createElement("button"),m.textContent="Retake",m.type="button",m.style.marginBottom="8px",m.style.background="#555",m.style.color="white",m.style.border="none",m.style.padding="10px 20px",m.style.borderRadius="10px",m.style.cursor="pointer",document.getElementById("camera-buttons").insertBefore(m,oe),m.addEventListener("click",async()=>{m.disabled=!0,u.classList.add("hidden"),m.remove(),z=!1,W.style.display="inline-block",window.innerWidth<768?C.style.display="inline-block":C.style.display="none",a.style.display="none",f.style.display="block",c.value="",B.textContent="No file chosen";try{J(),await G(),H()}catch(e){console.error("Failed to restart camera:",e),alert("Could not access the camera. Please try again."),m.disabled=!1}setTimeout($,10)})}function H(){let t=S.getBoundingClientRect(),e=f.getBoundingClientRect(),l=e.top-t.top,s=e.left-t.left;a.style.position="absolute",a.style.top=l+"px",a.style.left=s+"px",a.style.width=e.width+"px",a.style.height=e.height+"px"}W.addEventListener("click",()=>{let t=document.getElementById("image-url");t&&(t.value=""),R=3,a.textContent=R,H(),a.style.display="flex",X.disabled=!0,W.style.display="none",C.style.display="none",f.style.display="block",le=setInterval(()=>{if(R--,R===0){ae(),de.play(),X.disabled=!1;let e=512,l=f.videoWidth,s=f.videoHeight,i=e/l;u.width=e,u.height=s*i,j?(T.save(),T.translate(u.width,0),T.scale(-1,1),T.drawImage(f,0,0,u.width,u.height),T.restore()):T.drawImage(f,0,0,u.width,u.height),z=!0,u.toBlob(n=>{if(!n){console.error("No blob returned from canvas.");return}let o=new File([n],"captured-photo.png",{type:"image/png"}),h=new DataTransfer;h.items.add(o),c.files=h.files,c.dispatchEvent(new Event("change"));let v=document.getElementById("image-url");v&&(v.value="")},"image/png"),setTimeout(()=>{f.style.display="none",C.style.display="none",u.classList.remove("hidden"),me(),setTimeout($,50)},100)}else a.textContent=R},1e3)});te.addEventListener("submit",async t=>{t.preventDefault();let e=document.getElementById("download-btn");e.style.display="none";let l=document.getElementById("share-buttons");l.style.display="none";let i=document.getElementById("image-url")?.value.trim();if((!c.files||c.files.length===0)&&!i){g.textContent="Please upload a file or enter an image URL before generating.",g.style.display="block";return}console.log("Submitting file:",c.files[0]),g.style.display="none",U.textContent="",w.style.display="none",D.style.display="inline-block";let n=document.getElementById("progress-bar"),o=document.getElementById("progress-text");n.style.display="block",o.style.display="block",n.value=0,o.textContent="0%";let h=1e4,v=Date.now(),y=setInterval(()=>{let O=Date.now()-v,p=Math.min(100,Math.floor(O/h*100));n.value=p,o.textContent=`${p}%`,p>=100&&clearInterval(y)},200),E=new FormData,K=document.getElementById("image-url").value.trim();K?E.append("imageUrl",K):E.append("photo",c.files[0]),E.append("selectedStyle",r.value),E.append("customPrompt",d.value),E.append("model",document.getElementById("model-select").value);try{let p=await(await fetch("/api/upload",{method:"POST",body:E})).json();if(D.style.display="none",clearInterval(y),n.style.display="none",o.style.display="none",console.log("Response data:",p),typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0){if(console.log("Setting image src to:",p.imageUrl),U.textContent=`Style applied: ${p.message.replace("Image processed in ","")}`,w.src=p.imageUrl,w.style.display="block",typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0){w.src=p.imageUrl,w.style.display="block",e.style.display="inline-block",l.style.display="block";let x=encodeURIComponent(p.imageUrl);document.getElementById("share-x").href=`https://x.com/intent/tweet?url=${x}&text=Check out my AI-generated art!`,document.getElementById("share-facebook").href=`https://www.facebook.com/sharer/sharer.php?u=${x}`,document.getElementById("share-pinterest").href=`https://pinterest.com/pin/create/button/?url=${x}&media=${x}&description=AI-generated art`;let N=document.getElementById("share-instagram");N.addEventListener("click",V=>{V.preventDefault(),navigator.clipboard.writeText(p.imageUrl).then(()=>{let A=N.textContent;N.textContent="Copied!",setTimeout(()=>{N.textContent=A},2e3)}).catch(A=>{console.error("Failed to copy text: ",A)})}),e.onclick=async()=>{try{let A=await(await fetch(w.src,{mode:"cors"})).blob(),Z=URL.createObjectURL(A),P=document.createElement("a");P.href=Z,P.download=`styled-image-${Date.now()}.jpg`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(Z)}catch(V){console.error("Failed to download image:",V)}}}else e.style.display="none";let Q=document.getElementById("style-select").value,se=I.find(x=>x.name===Q)?.prompt?.trim()??"",ie=d.value.trim(),re=document.getElementById("model-select").value,Y=x=>x.trim().toLowerCase().replace(/\bimg\b/g,"image").replace(/\s+/g," ").replace(/[.,;:!?]+$/,""),_=!1;re==="fofr"?_=!1:_=Y(ie)!==Y(se),U.textContent=_?"Custom prompt applied":`Style applied: ${Q}`}else console.error("Invalid imageUrl:",p.imageUrl),g.textContent="Received invalid image URL.",g.style.display="block"}catch(O){D.style.display="none",clearInterval(y),n.style.display="none",o.style.display="none",g.textContent="An error occurred. Please try again.",g.style.display="block",console.error(O)}});var ye=document.getElementById("randomize-style"),pe=document.getElementById("surprise-me");pe.addEventListener("click",()=>{let t=Array.from(k.options).map(l=>l.value),e=t[Math.floor(Math.random()*t.length)];k.value=e,ee().then(()=>{let l=Array.from(r.options).map(n=>n.value),s=l[Math.floor(Math.random()*l.length)];r.value=s;let i=e==="photomaker"?"img":"image";d.value=`A portrait ${i} in the style of ${s}`,te.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))})});ye.addEventListener("click",()=>{let t=k.value;if(t==="fofr"){let e=b[Math.floor(Math.random()*b.length)];r.value=e,d.value=`A portrait image in the style of ${e}`}else{if(!I||I.length===0)return;let e=I[Math.floor(Math.random()*I.length)];r.value=e.name;let l=e.prompt;t==="photomaker"&&(l=l.replace(/\bimage\b/g,"img")),d.value=l,U.textContent=""}});var L=document.getElementById("custom-prompt");L.addEventListener("input",()=>{L.style.height="auto",L.style.height=L.scrollHeight+"px"});window.addEventListener("load",()=>{L.style.height="auto",L.style.height=L.scrollHeight+"px"});document.addEventListener("paste",async t=>{let e=t.clipboardData?.items;if(e)for(let l=0;l<e.length;l++){let s=e[l];if(s.kind==="file"&&s.type.startsWith("image/")){let i=s.getAsFile();if(i){let n=new DataTransfer;n.items.add(i),c.files=n.files,document.getElementById("image-url").value="",B.textContent=i.name||"Pasted image",c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Image pasted from clipboard:",i);return}}s.kind==="string"&&s.getAsString(i=>{i.startsWith("data:image/")&&fetch(i).then(n=>n.blob()).then(n=>{let o=new File([n],"pasted-image.png",{type:n.type}),h=new DataTransfer;h.items.add(o),c.files=h.files,document.getElementById("image-url").value="",B.textContent=o.name,c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Base64 image pasted and converted:",o)})})}});})();
