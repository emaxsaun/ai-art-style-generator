(()=>{var z=!1,de=new Audio("shutter.wav"),b=[],i=document.getElementById("style-select"),d=document.getElementById("custom-prompt");async function ee(){let e=await(await fetch("/api/styles")).json();b=e;let a=x.value,r=i.value;if(i.innerHTML="",a==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,i.appendChild(s)});let l=f.includes(r)?r:f[Math.floor(Math.random()*f.length)];i.value=l,d.value=`A portrait image in the style of ${i.value}`,d.disabled=!0,d.style.opacity="0.6"}else{e.forEach(C=>{let h=document.createElement("option");h.value=C.name,h.textContent=C.name,i.appendChild(h)});let l=e.find(C=>C.name===r),n=e[Math.floor(Math.random()*e.length)],s=l?l.name:n.name;i.value=s;let S=`A portrait ${a==="photomaker"?"img":"image"} in the style of ${i.value}`;d.value=S,d.disabled=!1,d.style.opacity="1"}}ee();var f=["3D","Emoji","Video game","Pixels","Clay","Toy"],x=document.getElementById("model-select");x.addEventListener("change",()=>{let t=x.value,e=i.value;if(t==="fofr"){i.innerHTML="";let a=x.value;if(i.innerHTML="",a==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,i.appendChild(s)});let l=f[Math.floor(Math.random()*f.length)];i.value=l,d.value=`A portrait img in the style of ${l}`,d.disabled=!0,d.style.opacity="0.6"}else{styles.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,i.appendChild(s)});let l=styles[Math.floor(Math.random()*styles.length)];i.value=l.name,d.value=l.prompt,d.disabled=!1,d.style.opacity="1"}let r=f[Math.floor(Math.random()*f.length)];i.value=r,d.value=`A portrait image in the style of ${r}`,d.disabled=!0,d.style.opacity="0.6"}else{i.innerHTML="",b.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,i.appendChild(s)});let a=b[0].name,r=b.find(n=>n.name===e);i.value=r?e:a;let l=t==="photomaker"?"img":"image";d.value=`A portrait ${l} in the style of ${i.value}`,d.disabled=!1,d.style.opacity="1"}});var ce=document.getElementById("generate-collage");ce.addEventListener("click",async()=>{let t=document.getElementById("download-btn");t.style.display="none";let e=document.getElementById("share-buttons");if(e.style.display="none",!c.files||c.files.length===0){y.textContent="Please upload a file before generating a collage.",y.style.display="block";return}y.style.display="none",T.textContent="",v.style.display="none",D.style.display="inline-block";let a=new FormData;a.append("photo",c.files[0]);try{let l=await(await fetch("/api/collage",{method:"POST",body:a})).json();D.style.display="none",l.success?(v.src=l.imageUrl,v.style.display="block",T.textContent="Collage generated!",t.style.display="inline-block"):(y.textContent=l.error||"An error occurred during collage generation.",y.style.display="block")}catch(r){D.style.display="none",y.textContent="An error occurred. Please try again.",y.style.display="block",console.error(r)}});i.addEventListener("change",()=>{let t=x.value,e=t==="photomaker"?"img":"image";t==="fofr"?d.value=`A portrait image in the style of ${i.value}`:d.value=`A portrait ${e} in the style of ${i.value}`});var te=document.getElementById("upload-form"),v=document.getElementById("result-img"),T=document.getElementById("style-display"),y=document.getElementById("error-message"),D=document.getElementById("loading-spinner"),c=document.getElementById("photo"),E=document.getElementById("filename-display");c.addEventListener("change",()=>{let t=document.getElementById("image-url");t&&(t.value=""),setTimeout(()=>{c.files&&c.files.length>0?E.textContent=c.files[0].name:E.textContent="No file chosen"},0)});var q=document.getElementById("image-url");q.addEventListener("input",()=>{if(q.value.trim()){let t=q.value.trim().split("/").pop().split("?")[0];E.textContent=t||"URL image selected"}else E.textContent="No file chosen"});var L=document.getElementById("drop-area");function ne(){window.innerWidth<768?L.style.display="none":L.style.display="block"}ne();window.addEventListener("resize",()=>{o.classList.contains("hidden")||H()});window.addEventListener("resize",ne);["dragenter","dragover"].forEach(t=>{L.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),L.classList.add("dragover")})});["dragleave","drop"].forEach(t=>{L.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),L.classList.remove("dragover")})});L.addEventListener("drop",t=>{let e=t.dataTransfer.files;e.length>0&&e[0].type.startsWith("image/")&&(c.files=e,E.textContent=e[0].name)});var X=document.getElementById("open-camera"),w=document.getElementById("toggle-camera"),M=document.getElementById("camera-modal"),g=document.getElementById("camera-stream"),W=document.getElementById("take-photo"),u=document.getElementById("snapshot"),oe=document.getElementById("close-camera"),F,j=!0,le,R,U=u.getContext("2d");async function G(){let t=j?"user":"environment";try{F=await navigator.mediaDevices.getUserMedia({video:{facingMode:t}}),g.srcObject=F,j?g.classList.add("mirror-preview"):g.classList.remove("mirror-preview")}catch(e){console.log("Could not access camera: "+e.message),M.classList.add("hidden")}}function $(){let t=window.innerWidth<768;!M.classList.contains("hidden")&&!z?w.style.display=t?"inline-block":"none":w.style.display="none"}$();window.addEventListener("resize",$);function J(){F&&(F.getTracks().forEach(t=>t.stop()),F=null)}X.addEventListener("click",async()=>{z=!1,M.classList.remove("hidden"),u.classList.add("hidden"),g.style.display="block",W.style.display="inline-block",window.innerWidth<768?w.style.display="inline-block":w.style.display="none",o.style.display="none",m&&m.remove(),await G(),H(),$()});w.addEventListener("click",async()=>{j=!j,J(),await G(),H()});oe.addEventListener("click",()=>{J(),M.classList.add("hidden"),ae(),u.classList.add("hidden"),g.style.display="block",W.style.display="inline-block",o.style.display="none",m&&m.remove(),c.value="",E.textContent="No file chosen",$(),z=!1,X.disabled=!1});var o=document.createElement("div");o.style.position="absolute";o.style.top=0;o.style.left=0;o.style.right=0;o.style.bottom="74px";o.style.display="flex";o.style.alignItems="center";o.style.justifyContent="center";o.style.fontSize="6rem";o.style.color="white";o.style.textShadow="0 0 10px black";o.style.backgroundColor="rgba(0,0,0,0.5)";o.style.zIndex=10;o.style.borderRadius="12px";o.style.userSelect="none";o.style.pointerEvents="none";o.style.display="none";M.style.position="relative";M.appendChild(o);function ae(){clearInterval(le),o.style.display="none"}var m;function me(){m=document.createElement("button"),m.textContent="Retake",m.type="button",m.style.marginBottom="8px",m.style.background="#555",m.style.color="white",m.style.border="none",m.style.padding="10px 20px",m.style.borderRadius="10px",m.style.cursor="pointer",document.getElementById("camera-buttons").insertBefore(m,oe),m.addEventListener("click",async()=>{m.disabled=!0,u.classList.add("hidden"),m.remove(),z=!1,W.style.display="inline-block",window.innerWidth<768?w.style.display="inline-block":w.style.display="none",o.style.display="none",g.style.display="block",c.value="",E.textContent="No file chosen";try{J(),await G(),H()}catch(e){console.error("Failed to restart camera:",e),alert("Could not access the camera. Please try again."),m.disabled=!1}setTimeout($,10)})}function H(){let t=M.getBoundingClientRect(),e=g.getBoundingClientRect(),a=e.top-t.top,r=e.left-t.left;o.style.position="absolute",o.style.top=a+"px",o.style.left=r+"px",o.style.width=e.width+"px",o.style.height=e.height+"px"}W.addEventListener("click",()=>{let t=document.getElementById("image-url");t&&(t.value=""),R=3,o.textContent=R,H(),o.style.display="flex",X.disabled=!0,W.style.display="none",w.style.display="none",g.style.display="block",le=setInterval(()=>{if(R--,R===0){ae(),de.play(),X.disabled=!1;let e=512,a=g.videoWidth,r=g.videoHeight,l=e/a;u.width=e,u.height=r*l,j?(U.save(),U.translate(u.width,0),U.scale(-1,1),U.drawImage(g,0,0,u.width,u.height),U.restore()):U.drawImage(g,0,0,u.width,u.height),z=!0,u.toBlob(n=>{if(!n){console.error("No blob returned from canvas.");return}let s=new File([n],"captured-photo.png",{type:"image/png"}),I=new DataTransfer;I.items.add(s),c.files=I.files,c.dispatchEvent(new Event("change"));let S=document.getElementById("image-url");S&&(S.value="")},"image/png"),setTimeout(()=>{g.style.display="none",w.style.display="none",u.classList.remove("hidden"),me(),setTimeout($,50)},100)}else o.textContent=R},1e3)});te.addEventListener("submit",async t=>{t.preventDefault();let e=document.getElementById("download-btn");e.style.display="none";let a=document.getElementById("share-buttons");a.style.display="none";let l=document.getElementById("image-url")?.value.trim();if((!c.files||c.files.length===0)&&!l){y.textContent="Please upload a file or enter an image URL before generating.",y.style.display="block";return}console.log("Submitting file:",c.files[0]),y.style.display="none",T.textContent="",v.style.display="none",D.style.display="inline-block";let n=document.getElementById("progress-bar"),s=document.getElementById("progress-text");n.style.display="block",s.style.display="block",n.value=0,s.textContent="0%";let I=1e4,S=Date.now(),C=setInterval(()=>{let O=Date.now()-S,p=Math.min(100,Math.floor(O/I*100));n.value=p,s.textContent=`${p}%`,p>=100&&clearInterval(C)},200),h=new FormData,K=document.getElementById("image-url").value.trim();K?h.append("imageUrl",K):h.append("photo",c.files[0]),h.append("selectedStyle",i.value),h.append("customPrompt",d.value),h.append("model",document.getElementById("model-select").value);try{let p=await(await fetch("/api/upload",{method:"POST",body:h})).json();if(D.style.display="none",clearInterval(C),n.style.display="none",s.style.display="none",console.log("Response data:",p),typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0){if(console.log("Setting image src to:",p.imageUrl),T.textContent=`Style applied: ${p.message.replace("Image processed in ","")}`,v.src=p.imageUrl,v.style.display="block",typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0){v.src=p.imageUrl,v.style.display="block",e.style.display="inline-block",a.style.display="block";let B=encodeURIComponent(p.imageUrl);document.getElementById("share-x").href=`https://x.com/intent/tweet?url=${B}&text=Check out my AI-generated art!`,document.getElementById("share-facebook").href=`https://www.facebook.com/sharer/sharer.php?u=${B}`,document.getElementById("share-pinterest").href=`https://pinterest.com/pin/create/button/?url=${B}&media=${B}&description=AI-generated art`;let N=document.getElementById("share-instagram");N.addEventListener("click",V=>{V.preventDefault(),navigator.clipboard.writeText(p.imageUrl).then(()=>{let A=N.textContent;N.textContent="Copied!",setTimeout(()=>{N.textContent=A},2e3)}).catch(A=>{console.error("Failed to copy text: ",A)})}),e.onclick=async()=>{try{let A=await(await fetch(v.src,{mode:"cors"})).blob(),Z=URL.createObjectURL(A),P=document.createElement("a");P.href=Z,P.download=`styled-image-${Date.now()}.jpg`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(Z)}catch(V){console.error("Failed to download image:",V)}}}else e.style.display="none";let Q=document.getElementById("style-select").value,se=b.find(B=>B.name===Q)?.prompt?.trim()??"",ie=d.value.trim(),re=document.getElementById("model-select").value,Y=B=>B.trim().toLowerCase().replace(/\bimg\b/g,"image").replace(/\s+/g," ").replace(/[.,;:!?]+$/,""),_=!1;re==="fofr"?_=!1:_=Y(ie)!==Y(se),T.textContent=_?"Custom prompt applied":`Style applied: ${Q}`}else console.error("Invalid imageUrl:",p.imageUrl),y.textContent="Received invalid image URL.",y.style.display="block"}catch(O){D.style.display="none",clearInterval(C),n.style.display="none",s.style.display="none",y.textContent="An error occurred. Please try again.",y.style.display="block",console.error(O)}});var pe=document.getElementById("randomize-style"),ye=document.getElementById("surprise-me");ye.addEventListener("click",()=>{let t=Array.from(x.options).map(a=>a.value),e=t[Math.floor(Math.random()*t.length)];x.value=e,ee().then(()=>{let a=Array.from(i.options).map(n=>n.value),r=a[Math.floor(Math.random()*a.length)];i.value=r;let l=e==="photomaker"?"img":"image";d.value=`A portrait ${l} in the style of ${r}`,te.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))})});pe.addEventListener("click",()=>{let t=x.value;if(t==="fofr"){let e=f[Math.floor(Math.random()*f.length)];i.value=e,d.value=`A portrait image in the style of ${e}`}else{if(!b||b.length===0)return;let e=b[Math.floor(Math.random()*b.length)];i.value=e.name;let a=e.prompt;t==="photomaker"&&(a=a.replace(/\bimage\b/g,"img")),d.value=a,T.textContent=""}});var k=document.getElementById("custom-prompt");k.addEventListener("input",()=>{k.style.height="auto",k.style.height=k.scrollHeight+"px"});window.addEventListener("load",()=>{k.style.height="auto",k.style.height=k.scrollHeight+"px"});document.addEventListener("paste",async t=>{let e=t.clipboardData?.items;if(e)for(let a=0;a<e.length;a++){let r=e[a];if(r.kind==="file"&&r.type.startsWith("image/")){let l=r.getAsFile();if(l){let n=new DataTransfer;n.items.add(l),c.files=n.files,document.getElementById("image-url").value="",E.textContent=l.name||"Pasted image",c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Image pasted from clipboard:",l);return}}r.kind==="string"&&r.getAsString(l=>{l.startsWith("data:image/")&&fetch(l).then(n=>n.blob()).then(n=>{let s=new File([n],"pasted-image.png",{type:n.type}),I=new DataTransfer;I.items.add(s),c.files=I.files,document.getElementById("image-url").value="",E.textContent=s.name,c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Base64 image pasted and converted:",s)})})}});})();
