(()=>{var j=!1,b=[],i=document.getElementById("style-select"),d=document.getElementById("custom-prompt");async function Y(){let e=await(await fetch("/api/styles")).json();b=e;let a=k.value,r=i.value;if(i.innerHTML="",a==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,i.appendChild(s)});let l=f.includes(r)?r:f[Math.floor(Math.random()*f.length)];i.value=l,d.value=`A portrait image in the style of ${i.value}`,d.disabled=!0,d.style.opacity="0.6"}else{e.forEach(B=>{let h=document.createElement("option");h.value=B.name,h.textContent=B.name,i.appendChild(h)});let l=e.find(B=>B.name===r),n=e[Math.floor(Math.random()*e.length)],s=l?l.name:n.name;i.value=s;let S=`A portrait ${a==="photomaker"?"img":"image"} in the style of ${i.value}`;d.value=S,d.disabled=!1,d.style.opacity="1"}}Y();var f=["3D","Emoji","Video game","Pixels","Clay","Toy"],k=document.getElementById("model-select");k.addEventListener("change",()=>{let t=k.value,e=i.value;if(t==="fofr"){i.innerHTML="";let a=k.value;if(i.innerHTML="",a==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,i.appendChild(s)});let l=f[Math.floor(Math.random()*f.length)];i.value=l,d.value=`A portrait img in the style of ${l}`,d.disabled=!0,d.style.opacity="0.6"}else{styles.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,i.appendChild(s)});let l=styles[Math.floor(Math.random()*styles.length)];i.value=l.name,d.value=l.prompt,d.disabled=!1,d.style.opacity="1"}let r=f[Math.floor(Math.random()*f.length)];i.value=r,d.value=`A portrait image in the style of ${r}`,d.disabled=!0,d.style.opacity="0.6"}else{i.innerHTML="",b.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,i.appendChild(s)});let a=b[0].name,r=b.find(n=>n.name===e);i.value=r?e:a;let l=t==="photomaker"?"img":"image";d.value=`A portrait ${l} in the style of ${i.value}`,d.disabled=!1,d.style.opacity="1"}});var re=document.getElementById("generate-collage");re.addEventListener("click",async()=>{let t=document.getElementById("download-btn");t.style.display="none";let e=document.getElementById("share-buttons");if(e.style.display="none",!c.files||c.files.length===0){p.textContent="Please upload a file before generating a collage.",p.style.display="block";return}p.style.display="none",T.textContent="",v.style.display="none",$.style.display="inline-block";let a=new FormData;a.append("photo",c.files[0]);try{let l=await(await fetch("/api/collage",{method:"POST",body:a})).json();$.style.display="none",l.success?(v.src=l.imageUrl,v.style.display="block",T.textContent="Collage generated!",t.style.display="inline-block"):(p.textContent=l.error||"An error occurred during collage generation.",p.style.display="block")}catch(r){$.style.display="none",p.textContent="An error occurred. Please try again.",p.style.display="block",console.error(r)}});i.addEventListener("change",()=>{let t=k.value,e=t==="photomaker"?"img":"image";t==="fofr"?d.value=`A portrait image in the style of ${i.value}`:d.value=`A portrait ${e} in the style of ${i.value}`});var Z=document.getElementById("upload-form"),v=document.getElementById("result-img"),T=document.getElementById("style-display"),p=document.getElementById("error-message"),$=document.getElementById("loading-spinner"),c=document.getElementById("photo"),E=document.getElementById("filename-display");c.addEventListener("change",()=>{let t=document.getElementById("image-url");t&&(t.value=""),setTimeout(()=>{c.files&&c.files.length>0?E.textContent=c.files[0].name:E.textContent="No file chosen"},0)});var V=document.getElementById("image-url");V.addEventListener("input",()=>{if(V.value.trim()){let t=V.value.trim().split("/").pop().split("?")[0];E.textContent=t||"URL image selected"}else E.textContent="No file chosen"});var L=document.getElementById("drop-area");function ee(){window.innerWidth<768?L.style.display="none":L.style.display="block"}ee();window.addEventListener("resize",()=>{o.classList.contains("hidden")||z()});window.addEventListener("resize",ee);["dragenter","dragover"].forEach(t=>{L.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),L.classList.add("dragover")})});["dragleave","drop"].forEach(t=>{L.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),L.classList.remove("dragover")})});L.addEventListener("drop",t=>{let e=t.dataTransfer.files;e.length>0&&e[0].type.startsWith("image/")&&(c.files=e,E.textContent=e[0].name)});var O=document.getElementById("open-camera"),w=document.getElementById("toggle-camera"),M=document.getElementById("camera-modal"),g=document.getElementById("camera-stream"),F=document.getElementById("take-photo"),u=document.getElementById("snapshot"),te=document.getElementById("close-camera"),R,W=!0,ne,P,U=u.getContext("2d");async function X(){let t=W?"user":"environment";try{R=await navigator.mediaDevices.getUserMedia({video:{facingMode:t}}),g.srcObject=R,W?g.classList.add("mirror-preview"):g.classList.remove("mirror-preview")}catch(e){console.log("Could not access camera: "+e.message),M.classList.add("hidden")}}function D(){let t=window.innerWidth<768;!M.classList.contains("hidden")&&!j?w.style.display=t?"inline-block":"none":w.style.display="none"}D();window.addEventListener("resize",D);function _(){R&&(R.getTracks().forEach(t=>t.stop()),R=null)}O.addEventListener("click",async()=>{j=!1,M.classList.remove("hidden"),u.classList.add("hidden"),g.style.display="block",F.style.display="inline-block",window.innerWidth<768?w.style.display="inline-block":w.style.display="none",o.style.display="none",m&&m.remove(),await X(),z(),D()});w.addEventListener("click",async()=>{W=!W,_(),await X(),z()});te.addEventListener("click",()=>{_(),M.classList.add("hidden"),oe(),u.classList.add("hidden"),g.style.display="block",F.style.display="inline-block",o.style.display="none",m&&m.remove(),c.value="",E.textContent="No file chosen",D(),j=!1,O.disabled=!1});var o=document.createElement("div");o.style.position="absolute";o.style.top=0;o.style.left=0;o.style.right=0;o.style.bottom="74px";o.style.display="flex";o.style.alignItems="center";o.style.justifyContent="center";o.style.fontSize="6rem";o.style.color="white";o.style.textShadow="0 0 10px black";o.style.backgroundColor="rgba(0,0,0,0.5)";o.style.zIndex=10;o.style.borderRadius="12px";o.style.userSelect="none";o.style.pointerEvents="none";o.style.display="none";M.style.position="relative";M.appendChild(o);function oe(){clearInterval(ne),o.style.display="none"}var m;function de(){m=document.createElement("button"),m.textContent="Retake",m.type="button",m.style.marginBottom="8px",m.style.background="#555",m.style.color="white",m.style.border="none",m.style.padding="10px 20px",m.style.borderRadius="10px",m.style.cursor="pointer",document.getElementById("camera-buttons").insertBefore(m,te),m.addEventListener("click",async()=>{m.disabled=!0,u.classList.add("hidden"),m.remove(),j=!1,F.style.display="inline-block",window.innerWidth<768?w.style.display="inline-block":w.style.display="none",o.style.display="none",g.style.display="block",c.value="",E.textContent="No file chosen";try{_(),await X(),z()}catch(e){console.error("Failed to restart camera:",e),alert("Could not access the camera. Please try again."),m.disabled=!1}setTimeout(D,10)})}function z(){let t=M.getBoundingClientRect(),e=g.getBoundingClientRect(),a=e.top-t.top,r=e.left-t.left;o.style.position="absolute",o.style.top=a+"px",o.style.left=r+"px",o.style.width=e.width+"px",o.style.height=e.height+"px"}F.addEventListener("click",()=>{let t=document.getElementById("image-url");t&&(t.value=""),P=3,o.textContent=P,z(),o.style.display="flex",O.disabled=!0,F.style.display="none",w.style.display="none",g.style.display="block",ne=setInterval(()=>{if(P--,P===0){oe(),O.disabled=!1;let e=512,a=g.videoWidth,r=g.videoHeight,l=e/a;u.width=e,u.height=r*l,W?(U.save(),U.translate(u.width,0),U.scale(-1,1),U.drawImage(g,0,0,u.width,u.height),U.restore()):U.drawImage(g,0,0,u.width,u.height),j=!0,u.toBlob(n=>{if(!n){console.error("No blob returned from canvas.");return}let s=new File([n],"captured-photo.png",{type:"image/png"}),I=new DataTransfer;I.items.add(s),c.files=I.files,c.dispatchEvent(new Event("change"));let S=document.getElementById("image-url");S&&(S.value="")},"image/png"),setTimeout(()=>{g.style.display="none",w.style.display="none",u.classList.remove("hidden"),de(),setTimeout(D,50)},100)}else o.textContent=P},1e3)});Z.addEventListener("submit",async t=>{t.preventDefault();let e=document.getElementById("download-btn");e.style.display="none";let a=document.getElementById("share-buttons");a.style.display="none";let l=document.getElementById("image-url")?.value.trim();if((!c.files||c.files.length===0)&&!l){p.textContent="Please upload a file or enter an image URL before generating.",p.style.display="block";return}console.log("Submitting file:",c.files[0]),p.style.display="none",T.textContent="",v.style.display="none",$.style.display="inline-block";let n=document.getElementById("progress-bar"),s=document.getElementById("progress-text");n.style.display="block",s.style.display="block",n.value=0,s.textContent="0%";let I=1e4,S=Date.now(),B=setInterval(()=>{let H=Date.now()-S,y=Math.min(100,Math.floor(H/I*100));n.value=y,s.textContent=`${y}%`,y>=100&&clearInterval(B)},200),h=new FormData,q=document.getElementById("image-url").value.trim();q?h.append("imageUrl",q):h.append("photo",c.files[0]),h.append("selectedStyle",i.value),h.append("customPrompt",d.value),h.append("model",document.getElementById("model-select").value);try{let y=await(await fetch("/api/upload",{method:"POST",body:h})).json();if($.style.display="none",clearInterval(B),n.style.display="none",s.style.display="none",console.log("Response data:",y),typeof y.imageUrl=="string"&&y.imageUrl.trim().length>0){if(console.log("Setting image src to:",y.imageUrl),T.textContent=`Style applied: ${y.message.replace("Image processed in ","")}`,v.src=y.imageUrl,v.style.display="block",typeof y.imageUrl=="string"&&y.imageUrl.trim().length>0){v.src=y.imageUrl,v.style.display="block",e.style.display="inline-block",a.style.display="block";let C=encodeURIComponent(y.imageUrl);document.getElementById("share-twitter").href=`https://twitter.com/intent/tweet?url=${C}&text=Check out my AI-generated art!`,document.getElementById("share-facebook").href=`https://www.facebook.com/sharer/sharer.php?u=${C}`,document.getElementById("share-pinterest").href=`https://pinterest.com/pin/create/button/?url=${C}&media=${C}&description=AI-generated art`,e.onclick=async()=>{try{let ie=await(await fetch(v.src,{mode:"cors"})).blob(),Q=URL.createObjectURL(ie),A=document.createElement("a");A.href=Q,A.download=`styled-image-${Date.now()}.jpg`,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(Q)}catch(K){console.error("Failed to download image:",K)}}}else e.style.display="none";let G=document.getElementById("style-select").value,le=b.find(C=>C.name===G)?.prompt?.trim()??"",ae=d.value.trim(),se=document.getElementById("model-select").value,J=C=>C.trim().toLowerCase().replace(/\bimg\b/g,"image").replace(/\s+/g," ").replace(/[.,;:!?]+$/,""),N=!1;se==="fofr"?N=!1:N=J(ae)!==J(le),T.textContent=N?"Custom prompt applied":`Style applied: ${G}`}else console.error("Invalid imageUrl:",y.imageUrl),p.textContent="Received invalid image URL.",p.style.display="block"}catch(H){$.style.display="none",clearInterval(B),n.style.display="none",s.style.display="none",p.textContent="An error occurred. Please try again.",p.style.display="block",console.error(H)}});var ce=document.getElementById("randomize-style"),me=document.getElementById("surprise-me");me.addEventListener("click",()=>{let t=Array.from(k.options).map(a=>a.value),e=t[Math.floor(Math.random()*t.length)];k.value=e,Y().then(()=>{let a=Array.from(i.options).map(n=>n.value),r=a[Math.floor(Math.random()*a.length)];i.value=r;let l=e==="photomaker"?"img":"image";d.value=`A portrait ${l} in the style of ${r}`,Z.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))})});ce.addEventListener("click",()=>{let t=k.value;if(t==="fofr"){let e=f[Math.floor(Math.random()*f.length)];i.value=e,d.value=`A portrait image in the style of ${e}`}else{if(!b||b.length===0)return;let e=b[Math.floor(Math.random()*b.length)];i.value=e.name;let a=e.prompt;t==="photomaker"&&(a=a.replace(/\bimage\b/g,"img")),d.value=a,T.textContent=""}});var x=document.getElementById("custom-prompt");x.addEventListener("input",()=>{x.style.height="auto",x.style.height=x.scrollHeight+"px"});window.addEventListener("load",()=>{x.style.height="auto",x.style.height=x.scrollHeight+"px"});document.addEventListener("paste",async t=>{let e=t.clipboardData?.items;if(e)for(let a=0;a<e.length;a++){let r=e[a];if(r.kind==="file"&&r.type.startsWith("image/")){let l=r.getAsFile();if(l){let n=new DataTransfer;n.items.add(l),c.files=n.files,document.getElementById("image-url").value="",E.textContent=l.name||"Pasted image",c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Image pasted from clipboard:",l);return}}r.kind==="string"&&r.getAsString(l=>{l.startsWith("data:image/")&&fetch(l).then(n=>n.blob()).then(n=>{let s=new File([n],"pasted-image.png",{type:n.type}),I=new DataTransfer;I.items.add(s),c.files=I.files,document.getElementById("image-url").value="",E.textContent=s.name,c.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Base64 image pasted and converted:",s)})})}});})();
