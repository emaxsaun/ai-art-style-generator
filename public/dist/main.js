(()=>{var F=!1,h=[],a=document.getElementById("style-select"),i=document.getElementById("custom-prompt");async function oe(){let e=await(await fetch("/api/styles")).json();h=e;let d=U.value,r=a.value;if(a.innerHTML="",d==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,a.appendChild(s)});let o=f.includes(r)?r:f[Math.floor(Math.random()*f.length)];a.value=o,i.value=`A portrait image in the style of ${a.value}`,i.disabled=!0,i.style.opacity="0.6"}else{e.forEach(u=>{let k=document.createElement("option");k.value=u.name,k.textContent=u.name,a.appendChild(k)});let o=e.find(u=>u.name===r),n=e[Math.floor(Math.random()*e.length)],s=o?o.name:n.name;a.value=s;let w=`A portrait ${d==="photomaker"?"img":"image"} in the style of ${a.value}`;i.value=w,i.disabled=!1,i.style.opacity="1"}}oe();var f=["3D","Emoji","Video game","Pixels","Clay","Toy"],U=document.getElementById("model-select");U.addEventListener("change",()=>{let t=U.value,e=a.value;if(t==="fofr"){a.innerHTML="";let d=U.value;if(a.innerHTML="",d==="fofr"){f.forEach(n=>{let s=document.createElement("option");s.value=n,s.textContent=n,a.appendChild(s)});let o=f[Math.floor(Math.random()*f.length)];a.value=o,i.value=`A portrait img in the style of ${o}`,i.disabled=!0,i.style.opacity="0.6"}else{styles.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,a.appendChild(s)});let o=styles[Math.floor(Math.random()*styles.length)];a.value=o.name,i.value=o.prompt,i.disabled=!1,i.style.opacity="1"}let r=f[Math.floor(Math.random()*f.length)];a.value=r,i.value=`A portrait image in the style of ${r}`,i.disabled=!0,i.style.opacity="0.6"}else{a.innerHTML="",h.forEach(n=>{let s=document.createElement("option");s.value=n.name,s.textContent=n.name,a.appendChild(s)});let d=h[0].name,r=h.find(n=>n.name===e);a.value=r?e:d;let o=t==="photomaker"?"img":"image";i.value=`A portrait ${o} in the style of ${a.value}`,i.disabled=!1,i.style.opacity="1"}});a.addEventListener("change",()=>{let t=U.value,e=t==="photomaker"?"img":"image";t==="fofr"?i.value=`A portrait image in the style of ${a.value}`:i.value=`A portrait ${e} in the style of ${a.value}`});var ae=document.getElementById("upload-form"),S=document.getElementById("result-img"),H=document.getElementById("style-display"),I=document.getElementById("error-message"),O=document.getElementById("loading-spinner"),m=document.getElementById("photo"),v=document.getElementById("filename-display");m.addEventListener("change",()=>{let t=document.getElementById("image-url");t&&(t.value=""),setTimeout(()=>{m.files&&m.files.length>0?v.textContent=m.files[0].name:v.textContent="No file chosen"},0)});var V=document.getElementById("image-url");V.addEventListener("input",()=>{if(V.value.trim()){let t=V.value.trim().split("/").pop().split("?")[0];v.textContent=t||"URL image selected"}else v.textContent="No file chosen"});var B=document.getElementById("drop-area");function K(){window.innerWidth<768?B.style.display="none":B.style.display="block"}K();window.addEventListener("resize",()=>{l.classList.contains("hidden")||W()});window.addEventListener("resize",K);["dragenter","dragover"].forEach(t=>{B.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),B.classList.add("dragover")})});["dragleave","drop"].forEach(t=>{B.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),B.classList.remove("dragover")})});B.addEventListener("drop",t=>{let e=t.dataTransfer.files;e.length>0&&e[0].type.startsWith("image/")&&(m.files=e,v.textContent=e[0].name)});var j=document.getElementById("open-camera"),E=document.getElementById("toggle-camera"),x=document.getElementById("camera-modal"),g=document.getElementById("camera-stream"),P=document.getElementById("take-photo"),y=document.getElementById("snapshot"),Q=document.getElementById("close-camera"),$,A=!0,Y,R,M=y.getContext("2d");async function X(){let t=A?"user":"environment";try{$=await navigator.mediaDevices.getUserMedia({video:{facingMode:t}}),g.srcObject=$,A?g.classList.add("mirror-preview"):g.classList.remove("mirror-preview")}catch(e){console.log("Could not access camera: "+e.message),x.classList.add("hidden")}}function T(){let t=window.innerWidth<768;!x.classList.contains("hidden")&&!F?E.style.display=t?"inline-block":"none":E.style.display="none"}T();window.addEventListener("resize",T);function _(){$&&($.getTracks().forEach(t=>t.stop()),$=null)}j.addEventListener("click",async()=>{F=!1,x.classList.remove("hidden"),y.classList.add("hidden"),g.style.display="block",P.style.display="inline-block",window.innerWidth<768?E.style.display="inline-block":E.style.display="none",l.style.display="none",c&&c.remove(),await X(),W(),T()});E.addEventListener("click",async()=>{A=!A,_(),await X(),W()});Q.addEventListener("click",()=>{_(),x.classList.add("hidden"),Z(),y.classList.add("hidden"),g.style.display="block",P.style.display="inline-block",l.style.display="none",c&&c.remove(),m.value="",v.textContent="No file chosen",T(),F=!1,j.disabled=!1});var l=document.createElement("div");l.style.position="absolute";l.style.top=0;l.style.left=0;l.style.right=0;l.style.bottom="74px";l.style.display="flex";l.style.alignItems="center";l.style.justifyContent="center";l.style.fontSize="6rem";l.style.color="white";l.style.textShadow="0 0 10px black";l.style.backgroundColor="rgba(0,0,0,0.5)";l.style.zIndex=10;l.style.borderRadius="12px";l.style.userSelect="none";l.style.pointerEvents="none";l.style.display="none";x.style.position="relative";x.appendChild(l);function Z(){clearInterval(Y),l.style.display="none"}var c;function se(){c=document.createElement("button"),c.textContent="Retake",c.type="button",c.style.marginBottom="8px",c.style.background="#555",c.style.color="white",c.style.border="none",c.style.padding="10px 20px",c.style.borderRadius="10px",c.style.cursor="pointer",document.getElementById("camera-buttons").insertBefore(c,Q),c.addEventListener("click",async()=>{c.disabled=!0,y.classList.add("hidden"),c.remove(),F=!1,P.style.display="inline-block",window.innerWidth<768?E.style.display="inline-block":E.style.display="none",l.style.display="none",g.style.display="block",m.value="",v.textContent="No file chosen";try{_(),await X(),W()}catch(e){console.error("Failed to restart camera:",e),alert("Could not access the camera. Please try again."),c.disabled=!1}setTimeout(T,10)})}function W(){let t=x.getBoundingClientRect(),e=g.getBoundingClientRect(),d=e.top-t.top,r=e.left-t.left;l.style.position="absolute",l.style.top=d+"px",l.style.left=r+"px",l.style.width=e.width+"px",l.style.height=e.height+"px"}P.addEventListener("click",()=>{let t=document.getElementById("image-url");t&&(t.value=""),R=3,l.textContent=R,W(),l.style.display="flex",j.disabled=!0,P.style.display="none",E.style.display="none",g.style.display="block",Y=setInterval(()=>{if(R--,R===0){Z(),j.disabled=!1;let e=512,d=g.videoWidth,r=g.videoHeight,o=e/d;y.width=e,y.height=r*o,A?(M.save(),M.translate(y.width,0),M.scale(-1,1),M.drawImage(g,0,0,y.width,y.height),M.restore()):M.drawImage(g,0,0,y.width,y.height),F=!0,y.toBlob(n=>{if(!n){console.error("No blob returned from canvas.");return}let s=new File([n],"captured-photo.png",{type:"image/png"}),b=new DataTransfer;b.items.add(s),m.files=b.files,m.dispatchEvent(new Event("change"));let w=document.getElementById("image-url");w&&(w.value="")},"image/png"),setTimeout(()=>{g.style.display="none",E.style.display="none",y.classList.remove("hidden"),se(),setTimeout(T,50)},100)}else l.textContent=R},1e3)});ae.addEventListener("submit",async t=>{t.preventDefault();let e=document.getElementById("download-btn");e.style.display="none";let r=document.getElementById("image-url")?.value.trim();if((!m.files||m.files.length===0)&&!r){I.textContent="Please upload a file or enter an image URL before generating.",I.style.display="block";return}console.log("Submitting file:",m.files[0]),I.style.display="none",H.textContent="",S.style.display="none",O.style.display="inline-block";let o=document.getElementById("progress-bar"),n=document.getElementById("progress-text");o.style.display="block",n.style.display="block",o.value=0,n.textContent="0%";let s=1e4,b=Date.now(),w=setInterval(()=>{let z=Date.now()-b,p=Math.min(100,Math.floor(z/s*100));o.value=p,n.textContent=`${p}%`,p>=100&&clearInterval(w)},200),u=new FormData,k=document.getElementById("image-url").value.trim();k?u.append("imageUrl",k):u.append("photo",m.files[0]),u.append("selectedStyle",a.value),u.append("customPrompt",i.value),u.append("model",document.getElementById("model-select").value);try{let p=await(await fetch("/api/upload",{method:"POST",body:u})).json();if(O.style.display="none",clearInterval(w),o.style.display="none",n.style.display="none",console.log("Response data:",p),typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0){console.log("Setting image src to:",p.imageUrl),H.textContent=`Style applied: ${p.message.replace("Image processed in ","")}`,S.src=p.imageUrl,S.style.display="block",typeof p.imageUrl=="string"&&p.imageUrl.trim().length>0?(S.src=p.imageUrl,S.style.display="block",e.style.display="inline-block",e.onclick=async()=>{try{let le=await(await fetch(S.src,{mode:"cors"})).blob(),J=URL.createObjectURL(le),D=document.createElement("a");D.href=J,D.download=`styled-image-${Date.now()}.jpg`,document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL(J)}catch(L){console.error("Failed to download image:",L)}}):e.style.display="none";let q=document.getElementById("style-select").value,ee=h.find(L=>L.name===q)?.prompt?.trim()??"",te=i.value.trim(),ne=document.getElementById("model-select").value,G=L=>L.trim().toLowerCase().replace(/\bimg\b/g,"image").replace(/\s+/g," ").replace(/[.,;:!?]+$/,""),N=!1;ne==="fofr"?N=!1:N=G(te)!==G(ee),H.textContent=N?"Custom prompt applied":`Style applied: ${q}`}else console.error("Invalid imageUrl:",p.imageUrl),I.textContent="Received invalid image URL.",I.style.display="block"}catch(z){O.style.display="none",clearInterval(w),o.style.display="none",n.style.display="none",I.textContent="An error occurred. Please try again.",I.style.display="block",console.error(z)}});var ie=document.getElementById("randomize-style");ie.addEventListener("click",()=>{let t=U.value;if(t==="fofr"){let e=f[Math.floor(Math.random()*f.length)];a.value=e,i.value=`A portrait image in the style of ${e}`}else{if(!h||h.length===0)return;let e=h[Math.floor(Math.random()*h.length)];a.value=e.name;let d=e.prompt;t==="photomaker"&&(d=d.replace(/\bimage\b/g,"img")),i.value=d,H.textContent=""}});var C=document.getElementById("custom-prompt");C.addEventListener("input",()=>{C.style.height="auto",C.style.height=C.scrollHeight+"px"});window.addEventListener("load",()=>{C.style.height="auto",C.style.height=C.scrollHeight+"px"});document.addEventListener("paste",async t=>{let e=t.clipboardData?.items;if(e)for(let d=0;d<e.length;d++){let r=e[d];if(r.kind==="file"&&r.type.startsWith("image/")){let o=r.getAsFile();if(o){let n=new DataTransfer;n.items.add(o),m.files=n.files,document.getElementById("image-url").value="",v.textContent=o.name||"Pasted image",m.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Image pasted from clipboard:",o);return}}r.kind==="string"&&r.getAsString(o=>{o.startsWith("data:image/")&&fetch(o).then(n=>n.blob()).then(n=>{let s=new File([n],"pasted-image.png",{type:n.type}),b=new DataTransfer;b.items.add(s),m.files=b.files,document.getElementById("image-url").value="",v.textContent=s.name,m.dispatchEvent(new Event("change")),console.log("\u{1F4CB} Base64 image pasted and converted:",s)})})}});})();
